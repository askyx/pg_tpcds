## TPC-DS FOR POSTGRES

This repository contains the scripts and tools to generate TPC-DS data sets for PostgreSQL. The scripts are written in PL/pgSQL and can be run on any PostgreSQL database. The tools are written in Python and can be used to generate data sets for different sizes and formats.

The TPC-DS benchmark is a popular industry benchmark for evaluating database performance. It consists of a set of queries that simulate a business scenario and measure the performance of a database system under a variety of workloads. The data sets generated by these scripts are used to evaluate the performance of different database systems and compare their performance under different workloads.

The scripts and tools in this repository can be used to generate TPC-DS data sets for PostgreSQL. The data sets can be used to evaluate the performance of different database systems and compare their performance under different workloads. The scripts and tools can also be used to generate data sets for different sizes and formats.

### REQUIREMENTS

- PostgreSQL
    this is a extension of PostgreSQL, you need to install it first.
- gcc 13 or higher

### SETUP

make sure you have installed the postgres and the `pg_config` is in your PATH.

```
git clone https://github.com/asky/pg_tpcds.git
cd pg_tpcds
cmake -Bbuild
cmake --build build --target install
```

### USAGE

```sql

create extension pg_tpcds;

select tpcds_prepare(true);

select dsdgen(1, true);

select query from tpcds_queries(1); \gset

:query

explain (analyze, format json) :query;

select tpcds_destroy();
```

### TEST

NEED ?

### LIMIATIONS

- The scripts and tools in this repository are not perfect and may contain errors.

* 以插件的形式存在，开箱即用
    * 表
        * DONE 默认标准表结构
        * DONE 提供额外方式，在 install 之前，提供自己的自定义的语句，例如创建index，install 的时候安装到指定位置，然后建表的时候，一起调用
    * 语句
        * 预先提供语句
            * 由于 pg function 必须要求有 return type， 所以没必要在执行的时候返回结果，要返回结果，哪就只能为每个语句建立一个type，然后建立对应的func
                * 可以在创建function的时候不提供 type，调用的时候指定，这也需要 99 个 sql 一一对应，也是比较麻烦
            * 默认配置建表语句
                * 提供一些配置文件，让用户可以配置
                    * 建表之前的需要运行的配置文件
                    * 建表之后的需要运行的配置文件
                        * 例如，创建索引等
                    * 执行语句的时候，需要有对应的pre 和 post 文件吗
        * 内置语句，然后提供一个 func，调用之后执行所有或者指定sql ，返回执行 state
            * 提供一个表，具体执行的记录
                * 执行语句 id
                * 持续时间
            * 执行之后支持把语句时间记录为标准结果，之后的语句执行支持diff 汇总表示
            ```
                 +---------++----------+----------+--------++----------+----------+--------+---------+
                 | Item    || Latency (ms/iter)   | Change || Throughput (iter/s) | Change | p-value |
                 |         ||      old |      new |        ||      old |      new |        |         |
                 +---------++----------+----------+--------++----------+----------+--------+---------+
                 | 01      ||   240.96 |   242.59 |   +1%˄ ||     4.15 |     4.12 |   -1%˄ |  0.1743 |
                 | 03      ||    72.77 |    71.89 |   -1%˄ ||    13.74 |    13.91 |   +1%˄ |  0.0000 |
                 | 06      ||   190.69 |   189.08 |   -1%˄ ||     5.24 |     5.29 |   +1%˄ |  0.0000 |
                 | 07      ||   313.03 |   301.89 |   -4%˄ ||     3.19 |     3.31 |   +4%˄ |  0.0000 |
                 | 09      ||   680.77 |   674.81 |   -1%  ||     1.47 |     1.48 |   +1%  |  0.0316 |
                +| 10      ||   172.56 |   154.58 |  -10%˄ ||     5.79 |     6.47 |  +12%˄ |  0.0000 |
                +| 13      ||   604.39 |   554.28 |   -8%˄ ||     1.65 |     1.80 |   +9%˄ |  0.0000 |
                +| 15      ||   123.14 |   114.06 |   -7%˄ ||     8.12 |     8.77 |   +8%˄ |  0.0000 |
                 | 16      ||    78.13 |    75.63 |   -3%˄ ||    12.80 |    13.22 |   +3%˄ |  0.0000 |
                +| 17      ||   567.08 |   486.19 |  -14%˄ ||     1.76 |     2.06 |  +17%˄ |  0.0000 |
                +| 19      ||   147.33 |   134.30 |   -9%˄ ||     6.79 |     7.45 |  +10%˄ |  0.0000 |
                +| 25      ||   417.45 |   336.71 |  -19%˄ ||     2.40 |     2.97 |  +24%˄ |  0.0000 |
                 | 26      ||   144.20 |   142.34 |   -1%˄ ||     6.93 |     7.02 |   +1%˄ |  0.0000 |
                 | 28      ||   608.72 |   606.65 |   -0%  ||     1.64 |     1.65 |   +0%  |  0.0000 |
                +| 29      ||   728.01 |   658.88 |   -9%  ||     1.37 |     1.52 |  +10%  |  0.0000 |
                 | 31      ||  1330.29 |  1331.45 |   +0%  ||     0.75 |     0.75 |   -0%  |  0.7729 |
                 | 32      ||    38.81 |    39.85 |   +3%˄ ||    25.77 |    25.09 |   -3%˄ |  0.0000 |
                 | 34      ||   165.56 |   166.73 |   +1%˄ ||     6.04 |     6.00 |   -1%˄ |  0.1673 |
                 | 35      ||   606.11 |   619.47 |   +2%  ||     1.65 |     1.61 |   -2%  |  0.0000 |
                -| 37      ||   524.69 |   555.13 |   +6%˄ ||     1.91 |     1.80 |   -5%˄ |  0.0169 |
                 | 39a     ||  1559.58 |  1598.77 |   +3%  ||     0.64 |     0.63 |   -2%  |  0.0000 |
                 | 39b     ||  1595.26 |  1561.32 |   -2%  ||     0.63 |     0.64 |   +2%  |  0.0003 |
                 | 41      ||   295.12 |   296.24 |   +0%˄ ||     3.39 |     3.38 |   -0%˄ |  0.0112 |
                -| 42      ||    84.08 |    87.99 |   +5%˄ ||    11.89 |    11.36 |   -4%˄ |  0.0000 |
                 | 43      ||   948.21 |   950.05 |   +0%  ||     1.05 |     1.05 |   -0%  |  0.7293 |
                +| 45      ||   140.93 |   133.05 |   -6%˄ ||     7.10 |     7.52 |   +6%˄ |  0.0000 |
                 | 48      ||  1085.72 |  1082.56 |   -0%  ||     0.92 |     0.92 |   +0%  |  0.6188 |
                 | 50      ||   141.86 |   137.15 |   -3%˄ ||     7.05 |     7.29 |   +3%˄ |  0.0000 |
                 | 52      ||    83.41 |    83.38 |   -0%˄ ||    11.99 |    11.99 |   +0%˄ |  0.8434 |
                 | 55      ||    80.38 |    80.28 |   -0%˄ ||    12.44 |    12.46 |   +0%˄ |  0.4343 |
                 | 62      ||   532.29 |   531.74 |   -0%˄ ||     1.88 |     1.88 |   +0%˄ |  0.1972 |
                 | 65      ||  1620.69 |  1650.20 |   +2%  ||     0.62 |     0.61 |   -2%  |  0.0241 |
                 | 69      ||   152.43 |   151.71 |   -0%˄ ||     6.56 |     6.59 |   +0%˄ |  0.0839 |
                 | 73      ||    88.12 |    85.80 |   -3%˄ ||    11.35 |    11.65 |   +3%˄ |  0.0000 |
                 | 79      ||   480.52 |   483.13 |   +1%˄ ||     2.08 |     2.07 |   -1%˄ |  0.0000 |
                 | 81      ||   171.32 |   167.61 |   -2%˄ ||     5.84 |     5.97 |   +2%˄ |  0.0000 |
                 | 82      ||   598.10 |   600.13 |   +0%˄ ||     1.67 |     1.67 |   -0%˄ |  0.8652 |
                 | 83      ||    50.31 |    48.24 |   -4%˄ ||    19.87 |    20.73 |   +4%˄ |  0.0700 |
                +| 85      ||   964.07 |   602.99 |  -37%˄ ||     1.04 |     1.66 |  +60%˄ |  0.0000 |
                 | 88      ||   690.92 |   678.71 |   -2%  ||     1.45 |     1.47 |   +2%  |  0.0000 |
                +| 91      ||    54.18 |    46.54 |  -14%˄ ||    18.46 |    21.48 |  +16%˄ |  0.0000 |
                 | 92      ||    33.95 |    32.68 |   -4%˄ ||    29.45 |    30.59 |   +4%˄ |  0.0000 |
                 | 93      ||  3800.48 |  3845.83 |   +1%  ||     0.26 |     0.26 |   -1%  |  0.2586 |
                +| 94      ||    53.16 |    50.46 |   -5%˄ ||    18.81 |    19.81 |   +5%˄ |  0.0000 |
                 | 95      ||  4858.59 |  4951.34 |   +2%  ||     0.21 |     0.20 |   -2%  |  0.6497 |
                 | 96      ||    64.02 |    63.89 |   -0%˄ ||    15.62 |    15.65 |   +0%˄ |  0.9087 |
                 | 97      ||  2681.77 |  2719.02 |   +1%  ||     0.37 |     0.37 |   -1%  |  0.2168 |
                 | 99      ||  1023.47 |  1022.82 |   -0%  ||     0.98 |     0.98 |   +0%  |  0.7330 |
                 +---------++----------+----------+--------++----------+----------+--------+---------+
                 | Sum     || 31687.60 | 31200.14 |   -2%  ||          |          |        |         |
                 | Geomean ||          |          |        ||          |          |   +3%  |         |
                 +---------++----------+----------+--------++----------+----------+--------+---------+
                 |   Notes || ˄ Execution stopped due to max runs reached                            |
                 +---------++----------+----------+--------++----------+----------+--------+---------+
            ```
        * 执行全部语句
        * 执行部分语句
        * 结果集的正确性验证

    * generate 语句
        * 默认语句存在一个表中

    * gen data
        * 支持某个表，或者全部表
        * 生产文件之后， copy 到表
        * 优化
            * 生成速度慢
            * 多线程，tpcds 多线程有没有问题
            * 或者把表切分为不同的线程，然后单独生成
            * pg 提供的接口调用 copy 多线程是否存在问题
        * 使用 sql 实现
            * 提供一个函数生成指定表的数据，返回生成文件位置
                * 表数据之间有依赖，不是每个表都需要显示指定
            * 异步调用 语句？
                * pg 支持sql 的异步调用，但是需要依赖 dblink
                * 或者自己直接实现

        ```
        1. 实现一个函数，
            1. 函数 dsdgen(sf, table, overwrite) 创建文件，返回文件路径
            2. copy 文件到表
        2. 异步执行这个函数
            * 
        ```

    * 正确性验证
        * 内置 sf 0.01 0.1 1 10 的 anwser ，运行之后验证结果的正确性

    * install
        * install 的 同时也保留原来的 tpcds 的可执行文件
        * 安装相关资源

    * drop exctension
        * 只执行externsion 的 drop 操作，其他额外的表视图等看情况
    * create extension 的时候
        * 先执行 cleanup 操作，在执行 prepare 操作

    